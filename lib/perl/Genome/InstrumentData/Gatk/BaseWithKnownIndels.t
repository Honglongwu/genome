#! /gsc/bin/perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';

use Test::More;

my $class = 'Genome::InstrumentData::Gatk::BaseWithKnownIndels';
use_ok($class) or die;

# Dummy class for testing
class Genome::InstrumentData::Gatk::BaseWithKnownIndelsTest { 
    is => 'Genome::InstrumentData::Gatk::BaseWithKnownIndels',
};

# Inputs
use_ok('Genome::InstrumentData::Gatk::Test') or die;
my $gatk_test = Genome::InstrumentData::Gatk::Test->get;
my $bam_source = $gatk_test->bam_source;
my $reference_build = $gatk_test->reference_build;
my $known_indel = $gatk_test->known_indel;
my %params = (
    bam_source => $bam_source,
    reference_build => $reference_build,
    known_indels => [$known_indel],
);

# Create
my $base_with_known_indels = Genome::InstrumentData::Gatk::BaseWithKnownIndelsTest->get_or_create(%params);
ok($base_with_known_indels, 'create gatk base with known indels');

# Known indels vcfs
my $known_indels_vcfs = $base_with_known_indels->known_indels_vcfs;
ok(@$known_indels_vcfs, 'known indels vcfs');
is_deeply([$base_with_known_indels->_tmpdir.'/'.$gatk_test->indel_result->id.'.vcf'], $known_indels_vcfs, 'known indels vcfs correctly named'); 
ok(-l $base_with_known_indels->_tmpdir.'/'.$gatk_test->indel_result->id.'.vcf', 'known indels vcfs correctly linked'); 

#print $base_with_known_indels->_tmpdir."\n";
#print $base_with_known_indels->output_dir."\n"; <STDIN>;
done_testing();
