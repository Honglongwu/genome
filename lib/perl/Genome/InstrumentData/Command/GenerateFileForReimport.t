#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";

use Genome::Utility::Test 'compare_ok';
use Test::More;

use_ok('Genome::InstrumentData::Command::GenerateFileForReimport') or die;

my $test_dir = Genome::Utility::Test->data_dir_ok('Genome::InstrumentData::Command::GenerateFileForReimport', 'v1');
#my $file = $test_dir.'/source-files.tsv';

my $library = Genome::Library->__define__(name => '__TEST_LIBRARY__');
my @instrument_data;
my $instdata_id = -100;
for my $format (qw/ bam fastq /) {
    my $instrument_data = Genome::InstrumentData::Imported->create(
        id => --$instdata_id,
        library => $library,
        subset_name => '2-AAXXAA',
        import_format => $format,
        user_name => 'apipe-builder',
        run_name => 'hiseq',
        lane => 2,
        original_data_path => '/a/'.$format,
        random => 'yep',
    );
    die 'Failed to create instrument data' if not $instrument_data;

    my $volume = Genome::Disk::Volume->get(mount_path => $test_dir);
    if ( not $volume ) {
        $volume = Genome::Disk::Volume->__define__(mount_path => $test_dir, disk_status => 'active');
    }

    my $alloc = Genome::Disk::Allocation->__define__(
        owner => $instrument_data,
        mount_path => $volume->mount_path,
        group_subdirectory => $format,
        allocation_path => '',
    );
    die "Failed to define allocation for genotype file!" if not $alloc;

    push @instrument_data, $instrument_data;
}

my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
my $file = $tmpdir.'/source_files.tsv';

my $generate = Genome::InstrumentData::Command::GenerateFileForReimport->create(
    instrument_data => \@instrument_data,
    file => $file,
);
ok($generate, 'create generate file for reimport');
ok($generate->execute, 'execute');
compare_ok($file, $test_dir.'/source_files.tsv', 'file matches');
#print "$file\n"; <STDIN>;

done_testing();
