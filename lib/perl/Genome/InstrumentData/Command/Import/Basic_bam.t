#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";

use Test::More;

use_ok('Genome::InstrumentData::Command::Import::Basic') or die;

my $sample = Genome::Sample->create(name => '__TEST_SAMPLE__');
ok($sample, 'Create sample');

my $source_bam = $ENV{GENOME_TEST_INPUTS}.'/Genome-InstrumentData-Command-Import-Basic/test.bam';
my $cmd = Genome::InstrumentData::Command::Import::Basic->create(
    sample => $sample,
    source_files => [$source_bam],
    import_source_name => 'broad',
    sequencing_platform => 'solexa',
    instrument_data_properties => [qw/ lane=2 flow_cell_id=XXXXXX /],
);
ok($cmd, "create import command");
ok($cmd->execute, "excute import command");

my $instrument_data2 = $cmd->instrument_data;
ok($instrument_data2, 'got instrument data 2');
is($instrument_data2->original_data_path, $source_bam, 'original_data_path correctly set');
is($instrument_data2->import_format, 'bam', 'import_format correctly set');
is($instrument_data2->sequencing_platform, 'solexa', 'sequencing_platform correctly set');
is($instrument_data2->is_paired_end, 1, 'is_paired_end correctly set');
is($instrument_data2->read_count, 600, 'read_count correctly set');
my $allocation2 = $instrument_data2->allocations;
ok($allocation2, 'got allocation');
ok($allocation2->kilobytes_requested > 0, 'allocation kb was set');

my $bam_via_bam_path = $instrument_data2->bam_path;
ok($bam_via_bam_path, 'got bam via bam path');
ok(-s $bam_via_bam_path, 'bam via bam path exists');
is($bam_via_bam_path, $allocation2->absolute_path.'/all_sequences.bam', 'bam via bam path named correctly');

my $bam_via_attrs = eval{ $instrument_data2->attributes(attribute_label => 'bam_path')->attribute_value; };
ok($bam_via_attrs, 'got bam via attrs');
ok(-s $bam_via_attrs, 'bam via attrs exists');
is($bam_via_attrs, $allocation2->absolute_path.'/all_sequences.bam', 'bam via attrs named correctly');

my $bam_via_archive_path = $instrument_data2->archive_path;
ok($bam_via_archive_path, 'got bam via archive path');
ok(-s $bam_via_archive_path, 'bam via archive path exists');
is($bam_via_archive_path, $allocation2->absolute_path.'/all_sequences.bam', 'bam via archive path named correctly');
#print $cmd->instrument_data->allocations->absolute_path."\n"; <STDIN>;

done_testing();
