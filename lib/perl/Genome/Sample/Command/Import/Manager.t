#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";
use Data::Dumper;
use Test::More;

use_ok('Genome::Sample::Command::Import::Manager') or die;

my $manager = Genome::Sample::Command::Import::Manager->create(
    working_directory => 'example/valid',
);
ok($manager, 'create manager');
ok($manager->execute, 'execute');
my %expected_samples = ( 
    'TEST-0000-00' => {
        name => 'TEST-0000-00', 
        original_data_path => 'original.bam',
        from_csv => { race => 'spaghetti', gender => 'female', religion => 'pastafarian', },
        status => 'sample_needed',
        job_status => 'pend',
        sample => undef, inst_data => undef, bam_path => undef, model => undef, build => undef,
    },
);
my $samples = $manager->samples;
is_deeply($manager->samples, \%expected_samples, 'samples match');

# fail - no config file
$manager = Genome::Sample::Command::Import::Manager->create(
    working_directory => 'example/invalid/no-config-yaml',
);
ok($manager, 'create manager');
ok(!$manager->execute, 'execute');
is($manager->error_message, "Property 'config_file': Config file does not exist! ".$manager->config_file, 'correct error');

# fail - no config file
$manager = Genome::Sample::Command::Import::Manager->create(
    working_directory => 'example/invalid/no-sample-csv',
);
ok($manager, 'create manager');
ok(!$manager->execute, 'execute');
is($manager->error_message, "Property 'sample_csv_file': Sample csv file does not exist! ".$manager->sample_csv_file, 'correct error');

# fail - no name column in csv
$manager = Genome::Sample::Command::Import::Manager->create(
    working_directory => 'example/invalid/no-name-column-in-sample-csv',
);
ok($manager, 'create manager');
ok(!$manager->execute, 'execute');
is($manager->error_message, 'No "name" column in sample csv! '.$manager->sample_csv_file, 'correct error');

done_testing();
