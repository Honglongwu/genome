#!/usr/bin/env genome-perl

use strict;
use warnings;

use above 'Genome';

use File::Temp;
use Test::More;

use_ok('Genome::Model::Build::MetagenomicComposition16s::AmpliconSet') or die;
use_ok('Genome::Model::Build::MetagenomicComposition16s::TestBuildFactory') or die;

my (undef, $example_build) = Genome::Model::Build::MetagenomicComposition16s::TestBuildFactory->build_with_example_build_for_454; # has chimara detection
ok($example_build, 'Got exmple build');

my @amplicon_sets = $example_build->amplicon_sets;
is(@amplicon_sets, 3, 'Got example ampolicon sets'); # only gonna test the first
my $amplicon_set = $amplicon_sets[0];

# Properties
my $file_base_name = '__TEST_SAMPLE__';
my $dir = $example_build->data_directory;
my %properties = (
    name => 'V1_V3',
    classifier => 'rdp2-2',
    chimera_detector => 'chimera-slayer',
    directory => $dir,
    file_base_name => $file_base_name,
);
for my $property ( keys %properties ) {
    is($amplicon_set->$property, $properties{$property}, "$property matches");
}

my %primers = Genome::Model::Build::MetagenomicComposition16s::SetNamesAndPrimers->_454;
is_deeply([$amplicon_set->primers], $primers{V1_V3}, "primers matche");

# Dirs
is($amplicon_set->fasta_dir, $dir.'/fasta', 'fasta dir base name');
is($amplicon_set->classification_dir, $dir.'/classification', 'classification dir base name');
is($amplicon_set->chimera_dir, $dir.'/chimera', 'chimera dir base name');

# Files
my $fasta_file_base_path = $amplicon_set->fasta_dir.'/'.$file_base_name;
is($amplicon_set->processed_fasta_file, $fasta_file_base_path.'.V1_V3.processed.fasta', 'processed fasta file');
is($amplicon_set->processed_qual_file, $fasta_file_base_path.'.V1_V3.processed.fasta.qual', 'processed qual file');
is($amplicon_set->oriented_fasta_file, $fasta_file_base_path.'.V1_V3.oriented.fasta', 'oriented fasta file');
is($amplicon_set->oriented_qual_file, $fasta_file_base_path.'.V1_V3.oriented.fasta.qual', 'oriented qual file');
is($amplicon_set->chimera_free_fasta_file, $fasta_file_base_path.'.V1_V3.oriented.chimera_free.fasta', 'chimera free fasta file');
is($amplicon_set->chimera_free_qual_file, $fasta_file_base_path.'.V1_V3.oriented.chimera_free.fasta.qual', 'chimera free qual file');

is($amplicon_set->classification_file, $amplicon_set->classification_dir.'/'.$file_base_name.'.V1_V3.'.$amplicon_set->classifier, 'classification file');
is($amplicon_set->chimera_free_classification_file, $amplicon_set->classification_dir.'/'.$file_base_name.'.V1_V3.chimera_free.'.$amplicon_set->classifier, 'chimera free classification file');

is($amplicon_set->chimera_file, $amplicon_set->chimera_dir.'/'.$file_base_name.'.V1_V3.chimera', 'chimera file');

# Readers
is($amplicon_set->chimera_detector_reader_class, 'Genome::Model::Tools::ChimeraSlayer::Reader', 'chimera detector reader');

# Amplicon
my @amplicons = _amplicons();
my $amplicon_iterator = $amplicon_set->amplicon_iterator;
my $first_amplicon = $amplicon_iterator->();
is_deeply($first_amplicon, $amplicons[0], 'first amplicon matches');
my $second_amplicon = $amplicon_iterator->();
is_deeply($second_amplicon, $amplicons[1], 'second amplicon matches');
my $cnt = 0;
while ( $amplicon_iterator->() ) { $cnt++; }
is($cnt, 3, 'got 3 more amplicons');

done_testing();

###

sub _amplicons {
    return (
        {
            'id' => 'FZ0V7MM01A01AQ',
            'name' => 'FZ0V7MM01A01AQ',
            'classification_line' => 'FZ0V7MM01A01AQ;-;Root:1.0;Bacteria:1.0;Fusobacteria:1.0;Fusobacteria:1.0;Fusobacteriales:1.0;Fusobacteriaceae:1.0;Fusobacterium:1.0;',
            'classification' => [
                'FZ0V7MM01A01AQ',
                '-',
                'Root:1.0',
                'Bacteria:1.0',
                'Fusobacteria:1.0',
                'Fusobacteria:1.0',
                'Fusobacteriales:1.0',
                'Fusobacteriaceae:1.0',
                'Fusobacterium:1.0'
            ],
            'seq' => {
                'qual' => '???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????',
                'desc' => undef,
                'id' => 'FZ0V7MM01A01AQ',
                'seq' => 'AGAGTTTGATCCTGGCTCAGGATGAACGCTGACAGAATGCTTAACACATGCAAGTCAACTTGAACGTTCGGTTTGGGTGGCGGACGGGTGAGTAACGCGTAAAGAACTTGCCTCACAGATAGGGACAACATTTGGAAACGAATGCTAATACCTGATATTATGATTTTAGGGCATCCTAGAATTATGAAAGCTATATGCGCTGTGAGAGGGCTTTGCGTCCCATTAGCTAGTTGGAGAGGTAACGGCTCACCAAGGCGATGATGGGTAGCCGGCCTGAGAGGGTGATCGGCCACAAGGGGACTGAGACACGGCCCTTACTCCTACGGGAGGCAGCAGTGGGGAATATTGGACAATGGACCAAGAGTCTGATCCAGCAATTCTGTGTGCACGATGAAGTTTTTCGGAATGTAAAGTGCTTTCAGTTGGGAAGAAAAAAATGACGGTACCAACAGAAGAAGTGACGGCTAAATACGTG'
            },
            'chimera_result' => {
                'percent_identity_right_A_left_B' => '-1',
                'percent_identity_left_A_right_B' => '-1',
                'parent_A' => 'NULL',
                'verdict' => 'NO',
                'parent_B' => 'NULL',
                'est_breakpoint_ECOLI' => undef,
                'est_breakpoint_NAST' => undef,
                'divergence_ratio_right_A_left_B' => '-1',
                'id' => 'FZ0V7MM01A01AQ',
                'divergence_ratio_left_A_right_B' => '-1',
                'confidence_left_A_right_B' => '-1',
                'confidence_right_A_left_B' => '-1'
            }
        },
        {
            'id' => 'FZ0V7MM01A01O4',
            'name' => 'FZ0V7MM01A01O4',
            'classification' => [
                'FZ0V7MM01A01O4',
                '-',
                'Root:1.0',
                'Bacteria:1.0',
                'Proteobacteria:1.0',
                'Gammaproteobacteria:1.0',
                'Enterobacteriales:1.0',
                'Enterobacteriaceae:1.0',
                'Escherichia/Shigella:0.95'
            ],
            'classification_line' => 'FZ0V7MM01A01O4;-;Root:1.0;Bacteria:1.0;Proteobacteria:1.0;Gammaproteobacteria:1.0;Enterobacteriales:1.0;Enterobacteriaceae:1.0;Escherichia/Shigella:0.95;',
            'seq' => {
                'qual' => '???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????',
                'desc' => undef,
                'id' => 'FZ0V7MM01A01O4',
                'seq' => 'GGCGGCAGGCCTAACACATGCAAGTCGAACGGTAACAGGAAGCAGCTTGCTGCTTGCTGACGAGTGGCGGACGGGTGAGTAATGTCTGGGAAACTGCCTGATGGAGGGGGATAACTACTGGAAACGGTAGCTAATACCGCATAATGTCGCAAGACCAAAGAGGGGGACCTTCGGGCCTCTTGCCATCGGATGTGCCCAGATGGGATTAGCTGGTAGGTGGGGTAAAGGCTCACCTAGGCGACGATCCCTAGCTGGTCTGAGAGGATGACCAGCCACACTGGAACTGAGACACGGTCCAGACTCCTACGGGAGGCAGCAGTGGGGAATATTGCACAATGGGCGCAAGCCTGATGCAGCCATGCCGCGTGTATGAAGAAGGCCTTCGGGTTGTAAAGTACTTTCAGCGGGGAGGAAGGGAGTAAAGTTAATACCTTTGCTCATTGACGTTACCCGCAGAAGAAGCACCGGCTAACTCCGTG'
            },
            'chimera_result' => {
                'percent_identity_right_A_left_B' => '-1',
                'percent_identity_left_A_right_B' => '-1',
                'parent_A' => 'NULL',
                'verdict' => 'NO',
                'parent_B' => 'NULL',
                'est_breakpoint_ECOLI' => undef,
                'est_breakpoint_NAST' => undef,
                'divergence_ratio_right_A_left_B' => '-1',
                'id' => 'FZ0V7MM01A01O4',
                'divergence_ratio_left_A_right_B' => '-1',
                'confidence_left_A_right_B' => '-1',
                'confidence_right_A_left_B' => '-1'
            }
        }
    );
}

