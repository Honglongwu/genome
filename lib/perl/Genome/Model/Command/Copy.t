#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Model::Command::Copy') or die;

# Test ModelDeprecated

my $sample_deprecated = Genome::Sample->create(name => '__TEST_SAMPLE_1__');
my $model_deprecated = Genome::Model->get(2862809551); # apipe-test-04-ref_align
ok($model_deprecated, 'model');
$model_deprecated->target_region_set_name('BULLS_EYE');
is($model_deprecated->target_region_set_name, 'BULLS_EYE', 'set target region set name');
my $copy_deprecated = Genome::Model::Command::Copy->create( # use 37 instead of 36
    model => $model_deprecated,
    overrides => [ 
        'name=__COPY_DEPRECATED_TEST1__',
        'subject='.$sample_deprecated->id,
        'processing_profile=name=Feb 2011 Default Reference Alignment',
        'reference_sequence_build=102671028',
        'dbsnp_build=id=106375969',
        'annotation_reference_build=',  
        'target_region_set_name=',
        'instrument_data=',
    ],
);
ok($copy_deprecated, 'create');
$copy_deprecated->dump_status_messages(1);
ok($copy_deprecated->execute, 'execute');
my $new_model_deprecated = Genome::Model->get(name => '__COPY_DEPRECATED_TEST1__');
ok($new_model_deprecated, 'copied model');
is_deeply($new_model_deprecated->subject, $sample_deprecated, 'override subject');
is($new_model_deprecated->processing_profile->id, 2580856, 'override pp id');
is($new_model_deprecated->reference_sequence_build->id, 102671028, 'override ref seq build');
ok(!$new_model_deprecated->annotation_reference_build, 'undef annotation build');
ok(!$new_model_deprecated->annotation_reference_build_id, 'undef annotation build id');
is($new_model_deprecated->dbsnp_build->id, 106375969, 'override dbsnp build');
ok(!$new_model_deprecated->target_region_set_name, 'undef target region set name');
is_deeply([$new_model_deprecated->instrument_data], [], 'did not copy inst data');

my $rv_deprecated = system(qq(genome model copy 2862809551 name=__COPY_DEPRECATED_TEST2__ processing_profile='name=Feb 2011 Default Reference Alignment' target_region_set_name='CAMBRIDGE'));
is($rv_deprecated, 0, 'command line');


# Test Model

my $taxon = Genome::Taxon->create(name => '__TEST_SAMPLE_1__');
my $model = Genome::Model->get(2887424886); # apipe-test-protein-annotation
ok($model, 'model');
my $copy = Genome::Model::Command::Copy->create( # use 37 instead of 36
    model => $model,
    overrides => [ 
        'name=__COPY_TEST1__',
        'subject='.$taxon->id,
    ],
);
ok($copy, 'create');
$copy->dump_status_messages(1);
ok($copy->execute, 'execute');
my $new_model = Genome::Model->get(name => '__COPY_TEST1__');
ok($new_model, 'copied model');
is_deeply($new_model->subject, $taxon, 'override subject');

my $rv = system(qq(genome model copy 2887424886 name=__COPY_TEST2__ subject=name='human'));
is($rv, 0, 'command line');

done_testing();
