#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use above 'Genome';

use Test::More;

use_ok('Genome::Model::Command::Services::AssignQueuedInstrumentData') or die;

my @projects;
push @projects, Genome::Project->create(
    id => -4444,
    name => 'AQID-test-project',
);
ok($projects[0], 'create "gsc" project');
push @projects, Genome::Project->create(
    id => -1111,
    name => 'AQID-Test-Workorder',
);
ok($projects[1], 'create "work order" project');
my @model_groups = Genome::ModelGroup->get(uuid => [ map { $_->id } @projects ]);
is(@model_groups, 2, 'created model groups');

my $taxon = Genome::Taxon->get( species_name => 'human' );
my $individual = Genome::Individual->create(
    id => '-10',
    name => 'AQID-test-individual',
    common_name => 'AQID10',
    taxon_id => $taxon->id,
);

my $sample = Genome::Sample->create(
    id => '-1',
    name => 'AQID-test-sample',
    common_name => 'normal',
    source_id => $individual->id,
);

my $library = Genome::Library->create(
    id => '-2',
    name => 'test library',
    sample_id => $sample->id,
);

isa_ok($library, 'Genome::Library');
isa_ok($sample, 'Genome::Sample');

my (@instrument_data);
no warnings;
*Genome::InstrumentDataAttribute::get = sub {
    my ($class, %params) = @_;
    my %attrs = map { $_->id => $_ } map { $_->attributes } @instrument_data;
    for my $param_key ( keys %params ) {
        my @param_values = ( ref $params{$param_key} ? @{$params{$param_key}} : $params{$param_key} );
        my @unmatched_attrs;
        for my $attr ( values %attrs ) {
            next if grep { $attr->$param_key eq $_ } @param_values;
            push @unmatched_attrs, $attr->id;
        }
        for ( @unmatched_attrs ) { delete $attrs{$_} }
    }
    return values %attrs;
};
use warnings;

my $instrument_data_1 = Genome::InstrumentData::Solexa->create(
    id => '-100',
    library_id => $library->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
$instrument_data_1->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_1;
ok($instrument_data_1, 'Created an instrument data');
_add_instrument_data_to_projects($instrument_data_1);

my $processing_profile = Genome::ProcessingProfile::ReferenceAlignment->create(
    dna_type => 'genomic dna',
    name => 'AQID-test-pp',
    read_aligner_name => 'bwa',
    sequencing_platform => 'solexa',
    read_aligner_params => '#this is a test',
    transcript_variant_annotator_version => 1,
);
ok($processing_profile, 'Created a processing_profile');

my $ref_seq_build = Genome::Model::Build::ImportedReferenceSequence->get(name => 'NCBI-human-build36');
isa_ok($ref_seq_build, 'Genome::Model::Build::ImportedReferenceSequence') or die;

my $instrument_data_2 = Genome::InstrumentData::Solexa->create(
    id => '-101',
    library_id => $library->id,
    flow_cell_id => 'TM-021',
    lane => '2',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
$instrument_data_2->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_2;
_add_instrument_data_to_projects($instrument_data_2);

my $command_1 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
isa_ok($command_1, 'Genome::Model::Command::Services::AssignQueuedInstrumentData');

ok($command_1->execute(), 'assign-queued-instrument-data executed successfully.');

my $new_models = $command_1->_newly_created_models;
is(scalar(keys %$new_models), 1, 'the cron created one model');
is_deeply([sort map { $_->name } values %$new_models], [sort qw/ AQID-test-sample.prod-refalign /], 'the cron named the new models correctly');

my $models_changed = $command_1->_existing_models_assigned_to;
is(scalar(keys %$models_changed), 0, 'no models changed');

my $old_models = $command_1->_existing_models_with_existing_assignments;
is(scalar(keys %$old_models), 1, 'no existing models');

my ($old_model_id) = keys(%$old_models);
my $new_model = $new_models->{$old_model_id};
my $old_model = $old_models->{$old_model_id};
is_deeply($new_model, $old_model, 'the model created is the one reused');

ok($new_model->build_requested, 'the cron set the new model to be built');

my @models_for_sample = Genome::Model->get(
    subject_class_name => 'Genome::Sample',
    subject_id => $sample->id,
);
is(scalar(@models_for_sample), 1, 'found one model created for the subject');
is($models_for_sample[0], $new_model, 'that model is the same one the cron claims it created');

my @model_instrument_data = $new_model->instrument_data;
is(scalar(@model_instrument_data), 2, 'the first new model has two instrument data assigned');
is_deeply([sort(@model_instrument_data)], [sort($instrument_data_1, $instrument_data_2)], 'those two instrument data are the ones for run 2');

my $group = Genome::ModelGroup->get(name => 'AQID');
ok($group, 'auto-generated model-group exists');

my @members = $group->models;
ok(grep($_ eq $new_model, @members), 'group contains the newly created model');

my $instrument_data_ignored = Genome::InstrumentData::Solexa->create(
    id => '-1101',
    library_id => $library->id,
    flow_cell_id => 'TM-021',
    lane => '2',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
    ignored => 1,
);
$instrument_data_ignored->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_ignored;
_add_instrument_data_to_projects($instrument_data_ignored);

my $command_ignored = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
ok($command_ignored->execute(), 'assign-queued-instrument-data executed successfully.');
is(scalar(keys %{$command_ignored->_newly_created_models}), 0, 'the cron created no models from ignores.');
is($instrument_data_ignored->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on ignored inst data');

# Test AML build 36
my $aml_sample = Genome::Sample->get(name => "H_KA-758168-0912815");
my $aml_library = Genome::Library->create(id => '-1234', name => $aml_sample->name.'-testlib', sample_id => $aml_sample->id);
isa_ok($aml_sample, 'Genome::Sample');
isa_ok($aml_library, 'Genome::Library');
my $aml_instrument_data = Genome::InstrumentData::Solexa->create(
    id => '-11324234235',
    library_id => $aml_library->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
ok($aml_instrument_data, 'Created instrument data');
$aml_instrument_data->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $aml_instrument_data;
_add_instrument_data_to_projects($aml_instrument_data);

my $aml_command = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
ok($aml_command->execute(), 'assign-queued-instrument-data executed successfully.');
my %aml_new_models = %{$aml_command->_newly_created_models};
for my $model (values(%aml_new_models)) {
    is($model->reference_sequence_build_id, 106942997, 'aml model uses correct reference sequence');
}
is($aml_instrument_data->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on aml inst data');

# Test MEL
my $aml_library_2 = Genome::Library->create(id => '-12345', name => $aml_sample->name.'-testlib', sample_id => $aml_sample->id);
isa_ok($aml_library_2, 'Genome::Library');
my $aml_instrument_data_2 = Genome::InstrumentData::Solexa->create(
    id => '-113242342355',
    library_id => $aml_library->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
ok($aml_instrument_data_2, 'Created instrument data');
$aml_instrument_data_2->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $aml_instrument_data_2;
_add_instrument_data_to_projects($aml_instrument_data_2);

my $aml_command_2 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
ok($aml_command_2->execute(), 'assign-queued-instrument-data executed successfully.');
my %aml_new_models_2 = %{$aml_command_2->_newly_created_models};
for my $model (values(%aml_new_models_2)) {
    is($model->reference_sequence_build_id, 106942997, 'aml model uses correct reference sequence');
}
is($aml_instrument_data_2->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on aml inst data 2');

#Test mouse
my $mouse_taxon = Genome::Taxon->get( species_name => 'mouse' );
my $mouse_individual = Genome::Individual->create(
    id => '-111',
    name => 'AQID-mouse_test-individual',
    common_name => 'AQID_MOUSE_10',
    taxon_id => $mouse_taxon->id,
);

my $mouse_sample = Genome::Sample->create(
    id => '-1111',
    name => 'AQID-mouse_test-sample',
    common_name => 'normal',
    source_id => $mouse_individual->id,
);

my $mouse_library = Genome::Library->create(
    id => '-222',
    name => $mouse_sample->name.'-testlib',
    sample_id => $mouse_sample->id,
);

isa_ok($mouse_library, 'Genome::Library');
isa_ok($mouse_sample, 'Genome::Sample');

my $mouse_instrument_data = Genome::InstrumentData::Solexa->create(
    id => '-111111',
    library_id => $mouse_library->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
ok($mouse_instrument_data, 'Created an instrument data');
$mouse_instrument_data->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $mouse_instrument_data;
_add_instrument_data_to_projects($mouse_instrument_data);

my $mouse_command = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
ok($mouse_command->execute(), 'assign-queued-instrument-data executed successfully.');

my %mouse_new_models = %{$mouse_command->_newly_created_models};
is(scalar(keys %mouse_new_models), 1, 'the cron created one model from mouse sample.');
for my $mouse_model_id (keys %mouse_new_models){
    my $mouse_model = $mouse_new_models{$mouse_model_id};
    is($mouse_model->processing_profile_id, '2635769', 'mouse model has the correct procesing profile');
    is($mouse_model->annotation_reference_build_id, '106410073', 'mouse model has the correct annotation build');
    my @mouse_instrument_data = scalar($mouse_model->instrument_data);
    is(scalar(@mouse_instrument_data), 1, "mouse model has the expected 1 instrument data");
}
is($mouse_instrument_data->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on mouse inst data');

#Test rna
my $rna_sample = Genome::Sample->create(
    id => '-1001',
    name => 'AQID-rna-test-sample',
    common_name => 'normal',
    source_id => $individual->id,
    extraction_type => 'rna',
);

my $rna_library = Genome::Library->create(
    id => '-2002',
    name => 'rna library',
    sample_id => $rna_sample->id,
);

isa_ok($rna_library, 'Genome::Library');
isa_ok($rna_sample, 'Genome::Sample');

my $rna_instrument_data = Genome::InstrumentData::Solexa->create(
    id => '-100001',
    library_id => $rna_library->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
ok($rna_instrument_data, 'Created an instrument data');
$rna_instrument_data->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $rna_instrument_data;
_add_instrument_data_to_projects($rna_instrument_data);

my $rna_454_instrument_data = Genome::InstrumentData::454->create(
    id => '-14',
    library => $rna_library,
    region_number => 3,
    total_reads => 20,
    run_name => 'R_2010_01_09_11_08_12_FLX08080418_Administrator_100737113',
    sequencing_platform => '454',
);
isa_ok($rna_454_instrument_data, 'Genome::InstrumentData::454');
$rna_454_instrument_data->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $rna_454_instrument_data;

my $rna_command = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
ok($rna_command->execute(), 'assign-queued-instrument-data executed successfully.');

my $rna_new_models = $rna_command->_newly_created_models;
is(scalar(keys %$rna_new_models), 1, 'the cron created 1 rna model');
my ($rna_model) = values %$rna_new_models;
ok($rna_model->annotation_build, 'the cron set the annotation_build input on the rna model');
is($rna_instrument_data->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on rna solexa inst data');
is($rna_454_instrument_data->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'failed', 'Set tgi lims status to failed on rna 454 inst data (no ref)');

# Test ?
my $instrument_data_3 = Genome::InstrumentData::Solexa->create(
    id => '-102',
    library_id => $library->id,
    flow_cell_id => 'TM-021',
    lane => '3',
    index_sequence => 'CGTACG',
    subset_name => '3-CGTACG',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
$instrument_data_3->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_3;
_add_instrument_data_to_projects($instrument_data_3);

my $fl = Genome::FeatureList->__define__(
    id => 'ABCDEFG',
    name => 'test-capture-data',
    format => 'multi-tracked',
    content_type => 'targeted',
    file_content_hash => 1,
    reference => $ref_seq_build,
);

my $instrument_data_4 = Genome::InstrumentData::Solexa->create(
    id => '-103',
    library_id => $library->id, 
    flow_cell_id => 'TM-021',
    lane => '3',
    index_sequence => 'ACGTAC',
    subset_name => '3-ACGTAC',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
    target_region_set_name => 'test-capture-data',
);
$instrument_data_4->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_4;
_add_instrument_data_to_projects($instrument_data_4);

my $sample_pool = Genome::Sample->create(
    id => '-10001',
    name => 'AQID-test-sample-pooled',
    common_name => 'normal',
    source_id => $individual->id,
);

my $library_pool = Genome::Library->create(
    id => '-10002',
    name => $sample_pool->name.'-testlib',
    sample_id => $sample_pool->id,
);

my $instrument_data_pool = Genome::InstrumentData::Solexa->create(
    id => '-1003',
    library_id => $library_pool->id,
    flow_cell_id => 'TM-021',
    lane => '3',
    index_sequence => 'unknown',
    subset_name => '3-unknown',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
    target_region_set_name => 'test-capture-data',
);
push @instrument_data, $instrument_data_pool;
_add_instrument_data_to_projects($instrument_data_pool);

my $command_2 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
isa_ok($command_2, 'Genome::Model::Command::Services::AssignQueuedInstrumentData');
ok($command_2->execute(), 'assign-queued-instrument-data executed successfully.');

my $new_models_2 = $command_2->_newly_created_models;
is(scalar(keys %$new_models_2), 3, 'the cron created three new models (default, .wu-space, and .tcga-cds)');

my @models = values %$new_models_2;
@model_groups = ();
push(@model_groups, $_->model_groups) for (@models);

ok((grep {$_->name eq $sample_pool->name} @model_groups) > 0, "found model_group for sample_pool");
ok((grep {$_->name eq $sample_pool->name . '.wu-space'} @model_groups) > 0, "found wu-space model_group for sample_pool");
ok((grep {$_->name eq $projects[0]->name} @model_groups) > 0, "found model_group for project");
ok((grep {$_->name eq $projects[0]->name . '.wu-space'} @model_groups) > 0, "found wu-space model_group for project");

my $models_changed_2 = $command_2->_existing_models_assigned_to;
is(scalar(keys %$models_changed_2), 1, 'data was assigned to an existing model');

my $old_models_2 = $command_2->_existing_models_with_existing_assignments;
is(scalar(keys %$old_models_2), 1, 'after assigning to existing models found that model again in generic by-sample assignment');

my @new_models_2 = values(%$new_models_2);
my ($model_changed_2) = values(%$models_changed_2);
ok(!grep($_ eq $model_changed_2, @new_models_2), 'the models created are not the one reused');
is($model_changed_2, $new_model, 'the reused model is the one created previously');

for my $m (@new_models_2, $model_changed_2) {
    ok($m->build_requested, 'the cron set the model to be built');
}

my @new_refalign_models = grep($_->name !~ /prod-qc$/, @new_models_2);
is(scalar(@new_refalign_models), 3, 'created three refalign capture models (default, .wu-space, and .tcga-cds)');

for my $m (@new_refalign_models) {

    ok($m->region_of_interest_set_name, 'the new model has a region_of_interest_set_name defined');

    my @model_instrument_data = $m->instrument_data;
    is(scalar(@model_instrument_data),1, 'only one instrument data assigned');
    is($model_instrument_data[0],$instrument_data_4,'the instrument data is the capture data');
}

@models_for_sample = Genome::Model->get(
    subject_class_name => 'Genome::Sample',
    subject_id => $sample->id,
);

is(scalar(@models_for_sample), 4, 'found 4 models created for the subject');

@instrument_data = $new_model->instrument_data;
is(scalar(@instrument_data), 3, 'the new model has three instrument data assigned');
is_deeply([sort(@instrument_data)], [sort($instrument_data_1, $instrument_data_2, $instrument_data_3)], 'assigned expected inst data to model');

my @members_2 = $group->models;
is(scalar(@members_2) - scalar(@members), 3, 'two subsequent models added to the group');

is($instrument_data_3->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on inst data 3');
is($instrument_data_4->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed on inst data 4');
ok(!$instrument_data_pool->attributes(attribute_label => 'tgi_lims_status'), 'No tgi lims status on inst data pool');

# Test Adding to Existing and De Novo
my $instrument_data_5 = Genome::InstrumentData::Solexa->create(
    id => '-104',
    library_id => $library->id,
    flow_cell_id => 'TM-021',
    lane => '5',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
$instrument_data_5->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_5;
_add_instrument_data_to_projects($instrument_data_5);

my $de_novo_taxon = Genome::Taxon->get( species_name => 'Zinnia elegans' );
my $de_novo_individual = Genome::Individual->create(
    id => '-11',
    name => 'AQID-test-individual-ze',
    common_name => 'AQID11',
    taxon_id => $taxon->id,
);
my $de_novo_sample = Genome::Sample->create(
    id => '-22',
    name => 'AQID-test-sample-ze',
    common_name => 'normal',
    source_id => $de_novo_individual->id,
);
my $de_novo_library = Genome::Library->create(
    id=>'-33',
    name => $de_novo_sample->name.'-testlib',
    sample_id=>$de_novo_sample->id
);

my $instrument_data_6 = Genome::InstrumentData::Solexa->create(
    id => '-105',
    library_id => $de_novo_library->id,
    flow_cell_id => 'TM-021',
    lane => '6',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
$instrument_data_6->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_6;
_add_instrument_data_to_projects($instrument_data_6);

my $de_novo_processing_profile = Genome::ProcessingProfile::DeNovoAssembly->get(2354215); #apipe-test-de_novo_velvet_solexa

my $command_3 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
isa_ok($command_3, 'Genome::Model::Command::Services::AssignQueuedInstrumentData');
ok($command_3->execute(), 'assign-queued-instrument-data executed successfully.');

my $new_models_3 = $command_3->_newly_created_models;
is(scalar(keys %$new_models_3), 1, 'the cron created another new model');

my $models_changed_3 = $command_3->_existing_models_assigned_to;
is(scalar(keys %$models_changed_3), 1, 'added to existing non-capture model despite pp error');

my $old_models_3 = $command_3->_existing_models_with_existing_assignments;
is(scalar(keys %$old_models_3), 1, 'no other models were found with this data assigned');

my @models_for_de_novo_sample = Genome::Model->get(
    subject_class_name => 'Genome::Sample',
    subject_id => $de_novo_sample->id,
);
is(scalar(@models_for_de_novo_sample), 1, 'found 1 models created for the de-novo subject');

my($new_de_novo_model) = values %$new_models_3;
ok($new_de_novo_model->build_requested, 'the cron set the new model to be built');
my @de_novo_instrument_data = $new_de_novo_model->instrument_data;
is(scalar(@de_novo_instrument_data), 1, 'the new model has one instrument data assigned');
is($de_novo_instrument_data[0], $instrument_data_6, 'is the expected instrument data');

my($changed_model_3) = values %$models_changed_3;
is($changed_model_3, $new_model, 'latest addition is to the original model from the first run');

is($instrument_data_5->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lime status to failed for inst data 5');
is($instrument_data_6->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed for inst data 6');

# Test TCGA
my $sample_2 = Genome::Sample->create(
    id => '-70',
    name => 'TCGA-TEST-SAMPLE-01A-01D',
    common_name => 'normal',
    source_id => $individual->id,
    extraction_label => 'TCGA-Test',
);
ok($sample_2, 'Created TCGA sample');

my $sample_3 = Genome::Sample->create(
    id => '-71',
    name => 'TCGA-TEST-SAMPLE-10A-01D',
    common_name => 'normal',
    source_id => $individual->id,
    extraction_label => 'TCGA-Test',
);
ok($sample_3, 'Created TCGA sample pair');

my $library_2 = Genome::Library->create(
    id => '-7',
    name => $sample_2->name.'-testlib',
    sample_id => $sample_2->id,
);
isa_ok($library_2, 'Genome::Library');

my $fl2 = Genome::FeatureList->__define__(
    name => 'test-tcga-brc10', # This test was using the real BRC10 fl
    format => 'multi-tracked',
    content_type => 'targeted',
    file_content_hash => 1,
    reference => $ref_seq_build,
);
ok($fl2, 'Define feature list 2 for TCGA');

my $instrument_data_7 = Genome::InstrumentData::Solexa->create(
    id => '-700',
    library_id => $library_2->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
    target_region_set_name => $fl2->name,
);
ok($instrument_data_7, 'Created an instrument data');
$instrument_data_7->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_7;
_add_instrument_data_to_projects($instrument_data_7);

my $command_4 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
isa_ok($command_4, 'Genome::Model::Command::Services::AssignQueuedInstrumentData');
ok($command_4->execute(), 'assign-queued-instrument-data executed successfully.');

my $new_models_4 = $command_4->_newly_created_models;
is(scalar(keys %$new_models_4), 5, 'the cron created five new models');
my ($somatic_variation) =  grep($_->isa("Genome::Model::SomaticVariation"), values %$new_models_4);
my @tumor = grep($_->subject_name eq  $sample_2->name, values %$new_models_4);
my ($normal) = grep($_->subject_name eq  $sample_3->name, values %$new_models_4);
ok($somatic_variation, 'the cron created a somatic variation model');
ok(@tumor, 'the cron created a tumor model for the first sample');
ok($normal, 'the cron created a paired normal model');
ok(grep($_ ==  $somatic_variation->tumor_model, @tumor), 'somatic variation has the correct tumor model');
is($normal, $somatic_variation->normal_model, 'somatic variation has the correct normal model');
is(scalar @{[$normal->instrument_data]}, 0, 'no instrument data is assigned to the normal');
is($normal->build_requested, 0, 'the normal model does not have a build requested since no instrument data is assigned to it');

@models = values %$new_models_4;
push(@model_groups, $_->model_groups) for (@models);
ok((grep {$_->name =~ /\.tcga/} @model_groups), "found tcga-cds model_group");

is($instrument_data_7->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed for inst data 7');

# Test ?
my $library_3 = Genome::Library->create(
    id => '-9',
    name => $sample_3->name.'-testlib',
    sample_id => $sample_3->id,
);
isa_ok($library_3, 'Genome::Library');

my $instrument_data_8 = Genome::InstrumentData::Solexa->create(
    id => '-777',
    library_id => $library_3->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
    target_region_set_name => $fl2->name,
);
ok($instrument_data_8, 'Created an instrument data');
$instrument_data_8->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_8;
_add_instrument_data_to_projects($instrument_data_8);

my $command_5 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
isa_ok($command_5, 'Genome::Model::Command::Services::AssignQueuedInstrumentData');
ok($command_5->execute(), 'assign-queued-instrument-data executed successfully.');
my $new_models_5 = $command_5->_newly_created_models;
is(scalar(keys %$new_models_5), 0, 'the cron created zero new models');
ok(scalar($normal->instrument_data), 'the cron assigned the new instrument data to the empty paired model');

is($instrument_data_8->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed for inst data 8');

# Test ?
my $sample_4 = Genome::Sample->create(
    id => '-80',
    name => 'TCGA-TEST-SAMPLE2-01A-01D',
    common_name => 'normal',
    source_id => $individual->id,
    extraction_label => 'TCGA-Test',
);
ok($sample_4, 'Created TCGA sample');

my $sample_5 = Genome::Sample->create(
    id => '-81',
    name => 'TCGA-TEST-SAMPLE2-10A-01D',
    common_name => 'normal',
    source_id => $individual->id,
    extraction_label => 'TCGA-Test',
);
ok($sample_5, 'Created TCGA sample pair');

my $library_4 = Genome::Library->create(
    id => '-11',
    name => $sample_4->name.'-testlib',
    sample_id => $sample_4->id,
);
isa_ok($library_4, 'Genome::Library');

my $library_5 = Genome::Library->create(
    id => '-10',
    name => $sample_5->name.'-testlib',
    sample_id => $sample_5->id,
);
isa_ok($library_5, 'Genome::Library');

my $instrument_data_9 = Genome::InstrumentData::Solexa->create(
    id => '-800',
    library_id => $library_4->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
ok($instrument_data_9, 'Created an instrument data');
$instrument_data_9->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_9;
_add_instrument_data_to_projects($instrument_data_9);

my $instrument_data_10 = Genome::InstrumentData::Solexa->create(
    id => '-801',
    library_id => $library_5->id,
    flow_cell_id => 'TM-021',
    lane => '1',
    run_type => 'Paired',
    fwd_read_length => 100,
    rev_read_length => 100,
    fwd_clusters => 65535,
    rev_clusters => 65536,
);
ok($instrument_data_10, 'Created an instrument data');
$instrument_data_10->add_attribute(
    attribute_label => 'tgi_lims_status',
    attribute_value => 'new',
);
push @instrument_data, $instrument_data_10;
_add_instrument_data_to_projects($instrument_data_10);

my $command_6 = Genome::Model::Command::Services::AssignQueuedInstrumentData->create;
isa_ok($command_6, 'Genome::Model::Command::Services::AssignQueuedInstrumentData');
ok($command_6->execute(), 'assign-queued-instrument-data executed successfully.');

my $new_models_6 = $command_6->_newly_created_models;
is(scalar(keys %$new_models_6), 3, 'the cron created three new models');
my ($somatic_variation_2) =  grep($_->isa("Genome::Model::SomaticVariation"), values %$new_models_6);
my @tumor_2 = grep($_->subject_name eq  $sample_4->name, values %$new_models_6);
my ($normal_2) = grep($_->subject_name eq  $sample_5->name, values %$new_models_6);
ok($somatic_variation_2, 'the cron created a somatic variation model');
ok(@tumor_2, 'the cron created a tumor model for the first sample');
ok($normal_2, 'the cron created a paired normal model');
ok(grep($_ ==  $somatic_variation_2->tumor_model, @tumor_2), 'somatic variation has the correct tumor model');
is($normal_2, $somatic_variation_2->normal_model, 'somatic variation has the correct normal model');
is(scalar @{[$normal_2->instrument_data]}, 1, 'one instrument data is assigned to the normal');
is($normal->build_requested, 1, 'the normal model has build requested since there is instrument data is assigned to it');

is($instrument_data_9->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed for inst data 9');

is($instrument_data_10->attributes(attribute_label => 'tgi_lims_status')->attribute_value, 'processed', 'Set tgi lims status to processed for inst data 10');

done_testing();
exit;

sub _add_instrument_data_to_projects {
    my $instrument_data = shift;
    for my $project ( @projects ) { 
        $project->add_part(
            entity_id => $instrument_data->id, 
            entity_class_name => 'Genome::InstrumentData',
            label => 'instrument_data',
        );
    }
    return 1;
}

