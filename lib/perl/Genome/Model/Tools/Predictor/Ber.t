#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use Genome::Utility::Test qw(compare_ok);

use_ok('Genome::Model::Tools::Predictor::Ber') or die;

my $temp_output_dir = Genome::Sys->create_temp_directory();
ok(-d $temp_output_dir, "created temp output dir at $temp_output_dir");

my $test_data_path = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-Tools-Predictor';
my $test_fasta = join('/', $test_data_path, 'medium.fasta');
ok(-e $test_fasta, "test fasta file exists")or diag "test_fasta: $test_fasta";


my $version = '2.5';
my $ber = Genome::Model::Tools::Predictor::Ber->create(
    output_directory => $temp_output_dir,
    input_fasta_file => $test_fasta,
    version => $version,
#    parameters => '-cli -appl hmmpfam -appl hmmtigr -goterms -verbose -iprlookup -seqtype p -format raw',
    dump_predictions_to_file => 1,
);
ok($ber, 'successfully created ber command object');

ok($ber->execute, 'successfully executed ber');
ok(-e $ber->raw_output_path, "raw output file exists at expected location")
    or diag "expected location: " . $ber->raw_output_path;
ok(-e $ber->dump_output_path, "dump file exists at expected location")
    or diag "expected location: " . $ber->dump_output_path;

# Compare output to expected output
my $expected_raw_output = join('/', $test_data_path, 'ber.medium_fasta.raw.expected');
ok(-e $expected_raw_output, "expected raw output file for ber exists")
    or diag "expected_raw_output: $expected_raw_output";

my $expected_dump_output = join('/', $test_data_path, 'ber.medium_fasta.dump.expected');
ok (-e $expected_dump_output, "expected dump output file for ber exists")
    or diag "expected_dump_output: $expected_dump_output";

compare_ok($ber->dump_output_path, $expected_dump_output, "test dump output matches expected")
    or diag sprintf("test dump output: %s\nexpected dump output: %s\n", $ber->dump_output_path, $expected_dump_output);

my $ace_file = $ber->ace_file_path;
ok(-e $ace_file, "ber produced an ace file")
    or diag "ace_file: $ace_file";

done_testing();
