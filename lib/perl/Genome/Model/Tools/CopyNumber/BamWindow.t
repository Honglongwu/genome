#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use File::Path;
use File::Temp;
use Test::More;
use File::Compare;
use above 'Genome';

my $archos = `uname -a`;
if ($archos !~ /64/) {
    plan skip_all => "Must run from 64-bit machine";
}# else {
#    plan skip_all => "This is still under construction"; #tests => 4;
#}

use_ok('Genome::Model::Tools::CopyNumber::BamToCn');

my $test_data =  $ENV{GENOME_TEST_INPUTS} . "/Genome-Model-Tools-CopyNumber-BamWindow";

my $tmpbase = File::Temp::tempdir('BamWindowXXXXX', DIR => "$ENV{GENOME_TEST_TEMP}/", CLEANUP => 1);
my $output_file = "$tmpbase/output.bamwindow";
my $refbuild_id = 101947881;
my $bam = $test_data."/tumor.bam";
my $expected_output = $test_data."/expected_v1/output.bamwindow";

my $cmd = Genome::Model::Tools::CopyNumber::BamWindow->create(
                    bam_file => $bam,
                    output_file => $output_file,
                    window_size => 100000);


ok($cmd, 'gmt copy-number bam-window command created');

my $rv = $cmd->execute;

is($rv, 1, 'Testing for successful execution.  Expecting 1.  Got: '.$rv);

is(compare($output_file, $expected_output), 0, 'Output was identical to expected output.');
