#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use above 'Genome';

use Data::Dumper;
require File::Temp;
require File::Compare;
use Test::More;

use_ok('Genome::Model::GenotypeMicroarray::GenotypeFile::ReadTsvAndAnnotate') or die;

my $testdir = $ENV{GENOME_TEST_INPUTS} . '/Genome-InstrumentData-Command-Microarray';
my $testdir_version = $testdir.'/v2';
my $dbsnp_file = $testdir.'/dbsnp.132';
my $fl = Genome::Model::Tools::DetectVariants2::Result::Manual->__define__(
    description => '__TEST__DBSNP132__',
    username => 'apipe-tester',
    file_content_hash => 'c746fb7b7a88712d27cf71f8262dd6e8',
    output_dir => $testdir,
);
$fl->lookup_hash($fl->calculate_lookup_hash());
ok($fl, 'create dv2 result');
my $refseq_build = Genome::Model::Build::ReferenceSequence->__define__();
no warnings;
*Genome::Model::Build::ReferenceSequence::sequence = sub{ return 'A'; };
use warnings;
my $variation_list_build = Genome::Model::Build::ImportedVariationList->__define__(
    model => Genome::Model->get(2868377411),
    snv_result => $fl,
    version => 132,
    reference_id => $refseq_build->id,
);
ok($variation_list_build, 'create variation list build');

my $sample = Genome::Sample->__define__(
    name => '__TEST__SAMPLE__',
);
ok($sample, 'create sample');
my $library = Genome::Library->__define__(
    name => $sample->name.'-microarraylib',
    sample => $sample,
);
ok($library, 'create library');
my $instrument_data = Genome::InstrumentData::Imported->__define__(
    id => -7777,
    library => $library,
    import_format => 'genotype file',
    sequencing_platform => 'infinium',
);
ok(
    $instrument_data->add_attribute(attribute_label => 'genotype_file', attribute_value => $testdir_version.'/snpreport/-7777'),
    'add attr to inst data for genotype file',
);
ok($instrument_data, 'create instrument data');
$instrument_data->add_attribute(attribute_label => 'chip_name', attribute_value => 'test');
is($instrument_data->attributes(attribute_label => 'chip_name')->attribute_value, 'test', 'add attribute for chip name');
$instrument_data->add_attribute(attribute_label => 'version', attribute_value => '1');
is($instrument_data->attributes(attribute_label => 'version')->attribute_value, '1', 'add attribute for version');
$sample->default_genotype_data_id($instrument_data->id);

my $alloc_for_snpid_mapping = Genome::Disk::Allocation->__define__(
    disk_group_name => $ENV{GENOME_DISK_GROUP_ALIGNMENTS},
    group_subdirectory => '',
    mount_path => $testdir_version,
    allocation_path => 'microarray_data/infinium-test-1',
);
ok($alloc_for_snpid_mapping, 'define snpid mapping allocation');

no warnings;
*Genome::FeatureList::file_path = sub{ return $dbsnp_file };
use warnings;

my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
my $output = $tmpdir.'/genotypes.out';

my $reader = Genome::Model::GenotypeMicroarray::GenotypeFile::ReadTsvAndAnnotate->create(
    input => $testdir_version.'/snpreport/-7777',
    variation_list_build => $variation_list_build,
    snp_id_mapping => Genome::InstrumentData::Microarray->get_snpid_hash_for_variant_list($instrument_data, $variation_list_build),
);
ok($reader, 'create');

my @genotypes;
while ( my $genotype = $reader->read ) {
    push @genotypes, $genotype;
}
is_deeply(\@genotypes, _expected_genotypes(), 'genotypes match');

#print Data::Dumper::Dumper(\@genotypes);
done_testing();

sub _expected_genotypes {
    return [
        {
            'log_r_ratio' => '-0.3639',
            'position' => '752566',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'id' => 'rs3094315',
            'gc_score' => '0.8931',
            'alleles' => 'AG',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs3094315',
            'allele2' => 'G',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '-0.0539',
            'position' => '752721',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'id' => 'rs3131972',
            'gc_score' => '0.9256',
            'alleles' => 'AG',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs3131972',
            'allele2' => 'G',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '-0.0192',
            'position' => '798959',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'id' => 'rs11240777',
            'gc_score' => '0.8729',
            'alleles' => 'AG',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs11240777',
            'allele2' => 'G',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '0.2960',
            'position' => '800007',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'T',
            'id' => 'rs6681049',
            'gc_score' => '0.7156',
            'alleles' => 'TC',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs6681049',
            'allele2' => 'C',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '0.4694',
            'position' => '838555',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'C',
            'id' => 'rs4970383',
            'gc_score' => '0.8749',
            'alleles' => 'CC',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs4970383',
            'allele2' => 'C',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '-0.0174',
            'position' => '846808',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'C',
            'id' => 'rs4475691',
            'gc_score' => '0.8480',
            'alleles' => 'CC',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs4475691',
            'allele2' => 'C',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '0.0389',
            'position' => '854250',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'id' => 'rs7537756',
            'gc_score' => '0.8670',
            'alleles' => 'AA',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs7537756',
            'allele2' => 'A',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '0.1487',
            'position' => '873558',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'T',
            'id' => 'rs1110052',
            'gc_score' => '0.7787',
            'alleles' => 'TT',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'rs1110052',
            'allele2' => 'T',
            'sample_id' => '2879594813',
            'annotated' => 1
          },
          {
            'log_r_ratio' => '-0.0801',
            'position' => '882033',
            'cnv_confidence' => undef,
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'G',
            'id' => 'rs2272756',
            'gc_score' => '0.8677',
            'alleles' => 'GG',
            'chr' => '1',
            'ref' => 'A',
            'snp_name' => 'SNP_A-1',
            'allele2' => 'G',
            'sample_id' => '2879594813',
            'annotated' => 1
          }
    ];
}
