#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use above 'Genome';

use Test::More;

use_ok('Genome::Model::GenotypeMicroarray::GenotypeFile::FromInstDataReader') or die;
use_ok('Genome::Model::GenotypeMicroarray::Test') or die;

my $instdata = Genome::Model::GenotypeMicroarray::Test->instrument_data();
my $variation_list_build = Genome::Model::GenotypeMicroarray::Test->variation_list_build();

my $reader = Genome::Model::GenotypeMicroarray::GenotypeFile::FromInstDataReader->create(
    instrument_data => $instdata,
    variation_list_build => $variation_list_build,
);
ok($reader, 'create reader');
is_deeply($reader->{snp_id_mapping}, {}, 'no snp id mapping available'); #FIXME create and test

my %cnts;
while ( my $genotype = $reader->read ) {
    $cnts{total}++;
    $cnts{id_ok}++ if $genotype->{id};
    $cnts{no_snp_name}++ if not $genotype->{snp_name};
}
is_deeply(\%cnts, { map { $_ => 10 } (qw/ total id_ok no_snp_name /) }, 'genotypes ok');

done_testing();
