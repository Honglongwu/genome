#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Model::GenotypeMicroarray::GenotypeFile::ReadTsv') or die;

my $original_genotype_file_path = $ENV{GENOME_TEST_INPUTS} . '/GenotypeMicroarray/build/-8888.original';
my $reader = Genome::Model::GenotypeMicroarray::GenotypeFile::ReadTsv->create(
    input => $original_genotype_file_path,
);
ok($reader, 'create') or die;
is_deeply($reader->headers, [qw/ chromosome	position	alleles	id	sample_id	log_r_ratio	gc_score	cnv_value	cnv_confidence	allele1	allele2 /], 'headers');
my @genotypes;
while ( my $genotype = $reader->read ) {
    push @genotypes, $genotype;
}
is_deeply(\@genotypes, _expected_genotypes(), 'genotypes match');

done_testing();

sub _expected_genotypes {
    return [
          {
            'log_r_ratio' => '-0.3639',
            'alleles' => 'AG',
            'position' => '752566',
            'allele2' => 'G',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.8931'
          },
          {
            'log_r_ratio' => '-0.0539',
            'alleles' => 'AG',
            'position' => '752721',
            'allele2' => 'G',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.9256'
          },
          {
            'log_r_ratio' => '-0.0192',
            'alleles' => 'AG',
            'position' => '798959',
            'allele2' => 'G',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.8729'
          },
          {
            'log_r_ratio' => '0.2960',
            'alleles' => 'TC',
            'position' => '800007',
            'allele2' => 'C',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'T',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.7156'
          },
          {
            'log_r_ratio' => '0.4694',
            'alleles' => 'CC',
            'position' => '838555',
            'allele2' => 'C',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'C',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.8749'
          },
          {
            'log_r_ratio' => '-0.0174',
            'alleles' => 'CC',
            'position' => '846808',
            'allele2' => 'C',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'C',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.8480'
          },
          {
            'log_r_ratio' => '0.0389',
            'alleles' => 'AA',
            'position' => '854250',
            'allele2' => 'A',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'A',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.8670'
          },
          {
            'log_r_ratio' => '0.1487',
            'alleles' => 'TT',
            'position' => '873558',
            'allele2' => 'T',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'T',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.7787'
          },
          {
            'log_r_ratio' => '-0.0801',
            'alleles' => 'GG',
            'position' => '882033',
            'allele2' => 'G',
            'cnv_confidence' => 'NA',
            'cnv_value' => '2.0',
            'chromosome' => '1',
            'allele1' => 'G',
            'sample_id' => '2879594813',
            'id' => undef,
            'gc_score' => '0.8677'
          }
        ];
}
