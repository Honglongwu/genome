#!/usr/bin/env perl

use above 'Genome';
use Test::More;
use File::Spec;

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

my $pkg = "Genome::File::Vcf::Differ";
use_ok($pkg);

test_same();
test_header();

test_more_lines();
test_fewer_lines();

test_chrom();

done_testing();

sub test_same {
    my $differ = new_differ('blessed.vcf', 'same.vcf');

    my %header_differences = $differ->header;
    my ($blessed_entry, $other_entry, @columns) = $differ->next();

    subtest 'NO DIFFERENCES' => sub {
        is_deeply(\%header_differences, {}, 'Found no header differences');
        is_deeply(\@columns, [], 'Found no body differences');
    };
}

sub test_header {
    my $differ = new_differ('blessed.vcf', 'header.vcf');
    my %header_differences = $differ->header;
    my ($blessed_entry, $other_entry, @columns) = $differ->next();

    subtest 'HEADER' => sub {
        is_deeply(\%header_differences, {
                test_file('blessed.vcf') => [
                    '##FORMAT=<ID=GT,Number=1,Type=String,Description="Genotype">',
                ],
                test_file('header.vcf') => [
                    '##FORMAT=<ID=GT,Number=1,Type=Integer,Description="Genotype">',
                ],
            }, 'Found header differences');

        is_deeply(\@columns, [], 'Found no body differences');
    };
}

sub test_more_lines {
    my $differ = new_differ('blessed.vcf', 'more_lines.vcf');
    my ($blessed_entry, $other_entry, @columns) = $differ->next();
    is($blessed_entry, undef, 'found undef for BLESSED entry when other file has MORE lines');
}

sub test_fewer_lines {
    my $differ = new_differ('blessed.vcf', 'fewer_lines.vcf');
    my ($blessed_entry, $other_entry, @columns) = $differ->next();
    is($other_entry, undef, 'found undef for OTHER entry when other file has FEWER lines');
}

sub test_chrom {
    my $differ = new_differ('blessed.vcf', 'chrom.vcf');
    my ($blessed_entry, $other_entry, @columns) = $differ->next();
    subtest 'CHROM' => sub{
        is_deeply(\@columns, ['CHROM'], 'Found that only the chromosome differs');
        is($blessed_entry->{chrom}, 1, 'Found expected value for BLESSED');
        is($other_entry->{chrom}, 2, 'Found expected value for OTHER');
    };
}


sub new_differ {
    my ($blessed, $other) = @_;
    return $pkg->new(test_file($blessed), test_file($other));
}

sub test_file {
    return File::Spec->join(__FILE__ . '.d', @_);
}

1;
