#!/usr/bin/env genome-perl

use strict;
use warnings FATAL => 'all';

use Test::More;
use above 'Genome';
use Genome::Utility::Test qw(compare_ok);
use Sub::Install qw(reinstall_sub);
use File::Slurp qw(write_file);
use Genome::Annotation::TestHelpers qw(test_dag_xml);
use Genome::Annotation::Plan::TestHelpers; # defines classes

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

my $pkg = 'Genome::Annotation::MasterCommand';
use_ok($pkg) || die;

my $build = get_build();

my $cmd = $pkg->create(build_id => $build->id);
test_dag_xml($cmd->dag, expected_xml());

done_testing();

sub get_build {
    my $build = Genome::Model::Build::SomaticVariation->__define__;

    my $plan = Genome::Annotation::Plan->create_from_file(plan_file());
    $plan->validate();
    reinstall_sub({
        into => $build->class,
        as => 'annotation_plan',
        code => sub {return $plan; },
    });
    return $build;
}

sub expected_xml {
    return File::Spec->join(test_dir(), 'expected.xml');
}

sub plan_file {
    return File::Spec->join(test_dir(), 'test.yaml');
}

sub test_dir {
    return __FILE__ . ".d";
}

