#! /gsc/bin/perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above 'Genome';

use Data::Dumper 'Dumper';
use Test::More;

use_ok('Genome::Site::TGI::Synchronize::UpdateApipeClasses') or die;

my $uac = Genome::Site::TGI::Synchronize::UpdateApipeClasses->create;
ok($uac, 'create update apipe classes');

my @tests = tests();
for my $test ( @tests ) {
    my $gsc_class = $test->{gsc_class};
    my $params = $test->{params};
    my $gsc_obj = $gsc_class->create(%$params);
    my $genome_class = $test->{genome_class};
    my $genome_obj = $genome_class->get(id => $gsc_obj->id);
    ok(!$genome_obj, "$genome_class data does not exist for $gsc_class for id ".$gsc_obj->id);
    my $method = $test->{method};
    ok($uac->$method($gsc_obj, $genome_class), $method);
    $genome_obj = $genome_class->get($gsc_obj->id);
    ok($genome_obj, "$genome_class exists for $gsc_class id ".$gsc_obj->id);

    for my $name ( keys %$params ) {
        my $param_value = $params->{$name} // 'NULL';
        my $gsc_value = $gsc_obj->$name // 'NULL';
        is($gsc_value, $param_value, $gsc_class.' '.$gsc_obj->id.' '.$name.' is '.$param_value);
        my $genome_value = eval{ $genome_obj->$name; };
        $genome_value = eval{ $genome_obj->attributes(attribute_label => $name)->attribute_value; } if not defined $genome_value;
        $genome_value //= 'NULL';
        is($genome_value, $gsc_value, $genome_class.' '.$genome_obj->id.' '.$name.' is '.$gsc_value);
    }
}

done_testing();

###

sub tests {
    # Ask ebelter/fdu about how to add a test if you'd like to add one
    return (
        {
            gsc_class => 'Genome::Site::TGI::Synchronize::Classes::LibrarySummary',
            genome_class => 'Genome::Library',
            method => '_create_librarysummary',
            params => {
                id => -2889531422,
                name => 'H_LA-9315-3290.1-cDNA-1-lib4',
                sample_id => 2887788990,
                protocol => 'Ovation SP Ultralow DR',
                original_insert_size => '300-500',
                library_insert_size => '325',
            },
        },
    );
}
