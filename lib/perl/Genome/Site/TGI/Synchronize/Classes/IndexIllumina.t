#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use strict;
use warnings;

use above 'Genome';
use Test::More;

my $lims_class = 'Genome::Site::TGI::Synchronize::Classes::IndexIllumina';
use_ok($lims_class) or die;

my $entity_name = $lims_class->entity_name;
ok($entity_name, 'entity name');
is($entity_name, 'instrument data solexa', 'entity name');
my $expected_genome_class = 'Genome::InstrumentData::Solexa';
is($lims_class->genome_class_for_comparison, $expected_genome_class, 'genome class for create');
is($lims_class->genome_class_for_create, $expected_genome_class, 'genome class for create');

my %properties = (# real example
    id          => Genome::InstrumentData->__meta__->autogenerate_new_object_id(),
    library_id  => 2893602880,
    run_name    => '131015_HWI-ST489_143184634_AC2LPUACXX',
    adaptor_path    => '/gscmnt/sata114/info/medseq/adaptor_sequences/solexa_adaptor_pcr_primer',
    analysis_software_version => 'CASAVA-1.8.2',
    bam_path        => '/gscmnt/gc6001/production/csf_143288757/gerald_C2LPUACXX_7_GCCGCGAT-GCCGCGAT.bam',
    clusters        => 18687845,
    fastqc_path     => '/gscmnt/sata162/production/C2LPUACXX/L007/GCCGCGAT-GCCGCGAT/fastqc',
    flow_cell_id    => 'C2LPUACXX',
    fwd_clusters    => 18687845,
    fwd_kilobases_read => 1868784500,
    fwd_read_length => 100,
    fwd_run_type    => 'Paired End Read 1',
    gerald_directory => '/gscmnt/gc1700/production/Unaligned_lane_7_143243592/Project_Dummy/Sample_lane7_GCCGCGAT-GCCGCGAT',
    index_sequence  => 'GCCGCGAT-GCCGCGAT',
    is_external     => 0,
    lane            => 7,
    read_length     => 100,
    rev_clusters    => 18687845,
    old_median_insert_size => 0,
    old_filt_error_rate_avg => 0,
    old_fwd_filt_aligned_clusters_pct => 0,
    old_fwd_filt_error_rate_avg => 0,
    old_rev_filt_aligned_clusters_pct => 0,
    old_rev_filt_error_rate_avg => 0,
    old_sd_above_insert_size => 0,
    old_sd_below_insert_size => 0,
    rev_kilobases_read => 1868784500,
    rev_read_length => 100,
    rev_run_type    => 'Paired End Read 2',
    run_type        => 'Paired',
    subset_name => '7-GCCGCGAT-GCCGCGAT',
    target_region_set_name => 'SeqCap EZ Human Exome v3.0'
);
my @properties_to_copy = $lims_class->properties_to_copy;
ok(@properties_to_copy, 'properties to copy');
is_deeply([sort keys %properties], [sort @properties_to_copy], 'correct properties to copy');
my @properties_to_keep_updated = $lims_class->properties_to_keep_updated;
ok(@properties_to_keep_updated, 'properties to keep updated');
cmp_ok(@properties_to_copy, '>', @properties_to_keep_updated, 'more properties to copy than keep updated');

my $lims_object = $lims_class->__define__(%properties);
ok($lims_object, "define lims $entity_name object");

my $genome_object = $lims_object->create_in_genome;
ok($genome_object, "create genome $entity_name object");
isa_ok($genome_object, $expected_genome_class);
is($genome_object->sequencing_platform, 'solexa', 'sequencing platform');

for my $property ( keys %properties ) {
    my $value = eval{ $genome_object->$property; };
    $value = eval{ $genome_object->attributes(attribute_label => $property)->attribute_value; } if not defined $value;
    is($value, $properties{$property}, "genome and lims $property matches => $value");
}

done_testing();
