#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454') or die;

my $cnt = 0;

my $id454 = Genome::InstrumentData::454->create(
    id => -100,
    library_id => -101,
    region_id => -301,
    region_number => 2,
    index_sequence => 'GATCGA',
    subset_name => '2-GATCGA',
    total_reads => 1000,
);

# update num_reads
my $misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.region_index_454',
    subject_id => $id454->id,
    subject_property_name => 'num_reads',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => 1000,
    new_value => '1001',
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454');
is($misc_update->lims_table_name, 'region_index_454', 'Correct lims table name');
my $genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::454', 'Correct genome class name');
my $genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.region_index_454	-100	num_reads	'1000'	'1000'	'1001'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->total_reads, '1001', 'Set total_reads on id454');

# update num_bases
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.region_index_454',
    subject_id => $id454->id,
    subject_property_name => 'num_bases',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => undef,
    new_value => '10001',
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454');
is($misc_update->lims_table_name, 'region_index_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.region_index_454	-100	num_bases	'NA'	'NULL'	'10001'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->total_bases_read, '10001', 'Set total_bases_read on id454');

# index sequence -> updates subset_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.region_index_454',
    subject_id => $id454->id,
    subject_property_name => 'index_sequence',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->index_sequence,
    new_value => 'TGGGGGT',
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454');
is($misc_update->lims_table_name, 'region_index_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.region_index_454	-100	index_sequence	'GATCGA'	'GATCGA'	'TGGGGGT'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->index_sequence, 'TGGGGGT', 'Update index_sequence on id454');
is($id454->subset_name, '2-TGGGGGT', 'Also updated subset_name on id454');

# update region_number -> updates subset_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.region_index_454',
    subject_id => $id454->id,
    subject_property_name => 'region_number',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->region_number,
    new_value => 3,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454');
is($misc_update->lims_table_name, 'region_index_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.region_index_454	-100	region_number	'2'	'2'	'3'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->region_number, 3, 'Update region_number on id454');
is($id454->subset_name, '3-TGGGGGT', 'Also updated subset_name on id454');

# update region_id -> updates subset_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.region_index_454',
    subject_id => $id454->id,
    subject_property_name => 'region_id',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->region_id,
    new_value => -302,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454');
is($misc_update->lims_table_name, 'region_index_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.region_index_454	-100	region_id	'-301'	'-301'	'-302'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->region_id, -302, 'Update region_number on id454');

# library_id -> skip
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.region_index_454',
    subject_id => $id454->id,
    subject_property_name => 'LIBRARY_ID',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->library_id,
    new_value => 3,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RegionIndex454');
is($misc_update->lims_table_name, 'region_index_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'SKIP', 'Correct result after update');
is($misc_update->status, "SKIP	UPDATE	test.region_index_454	-100	library_id	'-101'	'-101'	'3'", 'Correct status after update');
ok(!$misc_update->is_reconciled, 'Is NOT reconciled');
is($misc_update->status_message, 'Update for genome property name not supported => library_id', 'Correct status message after update');
is($id454->library_id, -101, 'Did NOT update library_id on id454');

done_testing();
