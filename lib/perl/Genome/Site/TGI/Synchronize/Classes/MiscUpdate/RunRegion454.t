#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RunRegion454') or die;

my $cnt = 0;

my $id454 = Genome::InstrumentData::454->create(
    id => -101,
    library_id => -201,
    region_id => -301,
    region_number => 2,
    index_sequence => 'GATCGA',
    subset_name => '2-GATCGA',
    run_name => '__RUN_NAME__',
);
my $id454_2 = Genome::InstrumentData::454->create(
    id => -102,
    library_id => -201,
    region_id => -301,
    region_number => 2,
    index_sequence => 'GATCGA',
    subset_name => '2-GATCGA',
    run_name => '__RUN_NAME__',
);

# library_id -> skip
my $misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.run_region_454',
    subject_id => $id454->region_id,
    subject_property_name => 'library_id',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->library_id,
    new_value => 3,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RunRegion454');
is($misc_update->lims_table_name, 'run_region_454', 'Correct lims table name');
my $genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::RunRegion454', 'Correct genome class name');
my $genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->region_id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'SKIP', 'Correct result after update');
is($misc_update->status, "SKIP	UPDATE	test.run_region_454	-301	library_id	'-201'	'-201'	'3'", 'Correct status after update');
ok(!$misc_update->is_reconciled, 'Is NOT reconciled');
is($misc_update->status_message, 'Update for genome property name not supported => library_id', 'Correct status message after update');
is($id454->library_id, -201, 'Did NOT update library_id on id454 1');
is($id454_2->library_id, -201, 'Did NOT update library_id on id454 2');

# update run_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.run_region_454',
    subject_id => $id454->region_id,
    subject_property_name => 'run_name',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->run_name,
    new_value => '__NEW_RUN_NAME__',
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RunRegion454');
is($misc_update->lims_table_name, 'run_region_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::RunRegion454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, -301, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.run_region_454	-301	run_name	'__RUN_NAME__'	'__RUN_NAME__'	'__NEW_RUN_NAME__'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->run_name, '__NEW_RUN_NAME__', 'Set total_reads on id454 #1');
is($id454_2->run_name, '__NEW_RUN_NAME__', 'Set total_reads on id454 #2');

# update is_paired_end
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.run_region_454',
    subject_id => $id454->region_id,
    subject_property_name => 'paired_end',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->is_paired_end,
    new_value => 1,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RunRegion454');
is($misc_update->lims_table_name, 'run_region_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::RunRegion454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, -301, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.run_region_454	-301	paired_end	'NA'	'NULL'	'1'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->is_paired_end, 1, 'Set is_paired_end on id454 #1');
is($id454_2->is_paired_end, 1, 'Set is_paired_end on id454 #2');

# update region number -> updates subset_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.run_region_454',
    subject_id => $id454->region_id,
    subject_property_name => 'region_number',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->region_number,
    new_value => 3,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RunRegion454');
is($misc_update->lims_table_name, 'run_region_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::RunRegion454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $id454->region_id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.run_region_454	-301	region_number	'2'	'2'	'3'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->region_number, 3, 'Update region_number on id454 1');
is($id454_2->region_number, 3, 'Update region_number on id454 2');
is($id454->subset_name, '3-GATCGA', 'Also updated subset_name on id454 1');
is($id454_2->subset_name, '3-GATCGA', 'Also updated subset_name on id454 2');

# update region_id
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.run_region_454',
    subject_id => $id454->region_id,
    subject_property_name => 'region_id',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $id454->region_id,
    new_value => -302,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::RunRegion454');
is($misc_update->lims_table_name, 'run_region_454', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::RunRegion454', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, -301, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.run_region_454	-301	region_id	'-301'	'-301'	'-302'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($id454->region_id, -302, 'Set region_id on id454 #1');
is($id454_2->region_id, -302, 'Set region_id on id454 #2');

done_testing();
