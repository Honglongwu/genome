#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Site::TGI::Synchronize::Classes::MiscUpdate::IndexIllumina') or die;

my $cnt = 0;

# update flow_cell_id
my $solexa = Genome::InstrumentData::Solexa->create(
    id => -100,
    library_id => -101,
    flow_cell_id => 'XXXXXX',
    lane => 2,
    index_sequence => 'GATCGA',
    subset_name => '2-GATCGA',
);
my $misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.index_illumina',
    subject_id => $solexa->id,
    subject_property_name => 'FLOW_CELL_ID',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => undef,
    new_value => 'YYYYYY',
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::IndexIllumina');
is($misc_update->lims_table_name, 'index_illumina', 'Correct lims table name');
my $genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::Solexa', 'Correct genome class name');
my $genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $solexa->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.index_illumina	-100	flow_cell_id	'XXXXXX'	'NULL'	'YYYYYY'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($solexa->flow_cell_id, 'YYYYYY', 'Set flow_cell_id on solexa');

# update index sequence -> updates subset_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.index_illumina',
    subject_id => $solexa->id,
    subject_property_name => 'INDEX_SEQUENCE',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $solexa->index_sequence,
    new_value => 'TGGGGGT',
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::IndexIllumina');
is($misc_update->lims_table_name, 'index_illumina', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::Solexa', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $solexa->id, 'Correct genome entity id');
$DB::single=1;
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.index_illumina	-100	index_sequence	'GATCGA'	'GATCGA'	'TGGGGGT'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($solexa->index_sequence, 'TGGGGGT', 'Update index_sequence on solexa');
is($solexa->subset_name, '2-TGGGGGT', 'Also updated subset_name on solexa');

# update lane -> updates subset_name
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.index_illumina',
    subject_id => $solexa->id,
    subject_property_name => 'LANE',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $solexa->lane,
    new_value => 3,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::IndexIllumina');
is($misc_update->lims_table_name, 'index_illumina', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::Solexa', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $solexa->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'PASS', 'Correct result after update');
is($misc_update->status, "PASS	UPDATE	test.index_illumina	-100	lane	'2'	'2'	'3'", 'Correct status after update');
ok($misc_update->is_reconciled, 'Is reconciled');
ok(!$misc_update->error_message, 'No error after update');
is($solexa->lane, 3, 'Update lane on solexa');
is($solexa->subset_name, '3-TGGGGGT', 'Also updated subset_name on solexa');

# library_id -> skip
$misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->create(
    subject_class_name => 'test.index_illumina',
    subject_id => $solexa->id,
    subject_property_name => 'LIBRARY_ID',
    editor_id => 'lims',
    edit_date => '2000-01-01 00:00:'.sprintf('%02d', $cnt++),
    old_value => $solexa->library_id,
    new_value => 3,
    description => 'UPDATE',
    is_reconciled => 0,
);
ok($misc_update, 'Define misc update');
isa_ok($misc_update, 'Genome::Site::TGI::Synchronize::Classes::MiscUpdate::IndexIllumina');
is($misc_update->lims_table_name, 'index_illumina', 'Correct lims table name');
$genome_class_name = $misc_update->genome_class_name;
is($genome_class_name, 'Genome::InstrumentData::Solexa', 'Correct genome class name');
$genome_entity = $misc_update->genome_entity;
ok($genome_entity, 'Got genome entity');
is($genome_entity->class, $genome_class_name, 'Correct genome entity class name');
is($genome_entity->id, $solexa->id, 'Correct genome entity id');
ok($misc_update->perform_update, 'Perform update');
is($misc_update->result, 'SKIP', 'Correct result after update');
is($misc_update->status, "SKIP	UPDATE	test.index_illumina	-100	library_id	'NA'	'-101'	'3'", 'Correct status after update');
ok(!$misc_update->is_reconciled, 'Is NOT reconciled');
is($misc_update->status_message, 'Update for genome property name not supported => library_id', 'Correct status message after update');
is($solexa->library_id, -101, 'Did NOT update library_id on solexa');

done_testing();
