#! /gsc/bin/perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use strict;
use warnings;

use above 'Genome';

use Test::More;

use_ok('Genome::Site::TGI::Synchronize::Classes::MiscUpdate') or die;
use_ok('Genome::Site::TGI::Synchronize::ReconcileMiscUpdate') or die;

my $entities = _define_entities();
ok($entities, 'define entities');
is(scalar(keys %$entities), 3, 'defined 3 entities');

my $misc_update_cnt = _define_misc_updates($entities);
ok($misc_update_cnt, 'define misc_updates');
my @misc_updates = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->get(
    'edit_date like' => '01-JAN-00 %',
);
is(@misc_updates, $misc_update_cnt, "found $misc_update_cnt defined misc updates");

my $reconcile = Genome::Site::TGI::Synchronize::ReconcileMiscUpdate->create();
ok($reconcile, 'create reconcile command');
#ok($reconcile->execute, 'create reconcile command');

done_testing();
exit;

sub _define_entities {
    my @attrs = (
        {
            _type => 'Taxon',
            id => -100,
            estimated_genome_size => 1000,
        },
        {
            _type => 'Individual',
            id => -200,
            taxon_id => -100,
        },
        {
            _type => 'Sample',
            id => -400,
            source_id => -200,
            cell_type => 'primary',
            nomenclature => 'WUGC',
            is_control => 1,
        },
    );
    my %entities;
    for my $attrs ( @attrs ) {
        my $type = delete $attrs->{_type};
        $attrs->{name} = '__TEST_'.$type.'__',
        my $genome_class = 'Genome::'.$type;
        my $genome_entity = $genome_class->__define__(%$attrs);
        ok($genome_entity, 'define genome '.$type);
        my $site_tgi_class = 'Genome::Site::TGI::Synchronize::Classes::'.$type;
        my $site_tgi_entity = $site_tgi_class->__define__(%$attrs);
        ok($site_tgi_entity, 'define site tgi '.$type);
        push @{$entities{$type}}, {
            genome_entity => $genome_entity,
            site_tgi_entity => $site_tgi_entity,
        }, 
    }

    return \%entities;
}

sub _define_misc_updates {
    my $entities = @_;
    my $misc_update_cnt = 0;
   
    my %class_to_subject_class_name = (
        'Genome::Taxon' => 'organism_taxon',
        'Genome::PopulationGroup' => 'population_group',
        'Genome::Individual' => 'organism_individual',
        'Genome::Sample' => 'organism_sample',
    );

    my @updates = (
        [ $entities->{taxon}->[0]->{site_tgi_entity}, 'domain', 'Eukaryota' ],
        [ $entities->{taxon}->[0]->{site_tgi_entity}, 'estimated_genome_size', '1000000' ],
    );
    for my $update ( @updates ) {
        my ($obj, $property_name, $new_value) = @$update;
        my $subject_property_name = $obj->lims_name_to_apipe_name($property_name);
        my $misc_update = Genome::Site::TGI::Synchronize::Classes::MiscUpdate->__define__(
            subject_class_name => 'test.'.$class_to_subject_class_name{$obj->class},
            subject_id => $obj->id,
            subject_property_name => $subject_property_name,
            editor_id => 'lims',
            edit_date => '01-JAN-00 00.00.00.00000 AM',
            old_value => $obj->$property_name,
            new_value => $new_value,
            description => 'UPDATE',
            is_reconciled => 0,
        );
        ok('define misc update for '.$obj->__display_name__);
        $misc_update_cnt++;
    }

    #,SUBJECT_CLASS_NAME,SUBJECT_ID,EDIT_DATE,OLD_VALUE,NEW_VALUE,EDITOR_ID,SUBJECT_PROPERTY_NAME,DESCRIPTION,IS_RECONCILED
    #gsc.organism_sample,2888805490,05-NOV-12 02.00.54.684423 PM,,2888906913,lims,default_genotype_seq_id,UPDATE,0

#SUBJECT_CLASS_NAME,SUBJECT_ID,EDIT_DATE,OLD_VALUE,NEW_VALUE,EDITOR_ID,SUBJECT_PROPERTY_NAME,DESCRIPTION,IS_RECONCILED
#ebelter.population_group_member,1234-1234,20-NOV-12 04.48.13.489921 PM,,1234,ebelter,pg_id,INSERT,0
#ebelter.population_group_member,1234-1234,20-NOV-12 04.48.13.489921 PM,,1234,ebelter,member_id,INSERT,0
#ebelter.population_group_member,1234-1234,20-NOV-12 04.52.23.107209 PM,1234,1235,ebelter,member_id,UPDATE,0
#ebelter.population_group_member,1234-1235,20-NOV-12 04.53.22.105461 PM,1234,,ebelter,pg_id,DELETE,0
#ebelter.population_group_member,1234-1235,20-NOV-12 04.53.22.105461 PM,1235,,ebelter,member_id,DELETE,0
#ebelter.sample_attribute,1234-caTissue-foo-bar,20-NOV-12 04.59.08.375769 PM,,1234,ebelter,organism_sample_id,INSERT,0
#ebelter.sample_attribute,1234-caTissue-foo-bar,20-NOV-12 04.59.08.375769 PM,,caTissue,ebelter,nomenclature,INSERT,0
#ebelter.sample_attribute,1234-caTissue-foo-bar,20-NOV-12 04.59.08.375769 PM,,foo,ebelter,attribute_label,INSERT,0
#ebelter.sample_attribute,1234-caTissue-foo-bar,20-NOV-12 04.59.08.375769 PM,,bar,ebelter,attribute_value,INSERT,0
#ebelter.sample_attribute,1234-caTissue-foo-bar,20-NOV-12 05.06.49.250613 PM,bar,bar-baz,ebelter,attribute_value,UPDATE,0
#ebelter.sample_attribute,1234-caTissue-foo-bar-baz,20-NOV-12 05.07.11.576091 PM,bar-baz,bar-baza,ebelter,attribute_value,UPDATE,0

    return $misc_update_cnt;
}

